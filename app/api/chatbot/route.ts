import { NextResponse } from 'next/server'

// Mock FAQ data
const faqs = [
  {
    question: "كيف أحجز موعد طبي؟",
    answer: "يمكنك حجز موعد طبي من خلال الذهاب إلى صفحة 'المراكز الطبية' واختيار المركز الطبي المناسب لك، ثم اختيار العيادة والطبيب وتحديد التاريخ والوقت المناسبين لك."
  },
  {
    question: "ما هي أوقات العمل للمركز الطبي؟",
    answer: "أوقات العمل تختلف حسب كل مركز طبي وعيادة. يمكنك الاطلاع على أوقات العمل عند اختيارك للمركز الطبي المطلوب."
  },
  {
    question: "كيف يمكنني إلغاء موعد محجز؟",
    answer: "يمكنك إلغاء الموعد من خلال الذهاب إلى صفحة 'المواعيد' واختيار الموعد الذي ترغب بإلغائه ثم الضغط على زر الإلغاء."
  },
  {
    question: "هل يمكنني تعديل موعد محجوز؟",
    answer: "نعم، يمكنك تعديل الموعد من خلال إلغاء الموعد الحالي وحجز موعد جديد في الوقت المناسب لك."
  },
  {
    question: "ما هي المستندات المطلوبة لحجز موعد؟",
    answer: "عند الحجز، يُرجى إحضار بطاقة الهوية أو جواز السفر. في حالة الأطفال، يُرجى إحضار شهادة الميلاد."
  },
  {
    question: "هل يمكنني حجز موعد لعضو آخر في العائلة؟",
    answer: "نعم، عند الحجز يمكنك إدخال معلومات المريض الذي سيحضر الموعد، سواء كان أنت أو أحد أفراد العائلة."
  }
]

// Clinic schedules data
const clinicSchedules = [
  {
    id: 1,
    name: "عيادات الدانا - مشفى القدس",
    schedule: `
📅 عيادات الدانا - مشفى القدس

الأحد:
- داخلية | جراحة عامة | هضمية | قلبية | مفصلية | صدرية

الاثنين:
- داخلية | جراحة عامة | هضمية

الثلاثاء:
- داخلية | جراحة عامة | قلبية | صدرية

الأربعاء:
- داخلية | جراحة عامة | قلبية | صدرية

الخميس:
- داخلية | جراحة عامة | قلبية
    `
  },
  {
    id: 2,
    name: "جدول دوام عيادات مركز كليبت الصحي",
    schedule: `
🏥 جدول دوام عيادات مركز كليبت الصحي

الأحد:
- أطفال: فاعلة
- داخلية: فاعلة
- نسائية: فاعلة
- اسنان: غير متاحة
- سوء تغذية: فاعلة

الاثنين:
- أطفال: غير متاحة
- داخلية: فاعلة
- نسائية: فاعلة
- اسنان: فاعلة
- سوء تغذية: فاعلة

الثلاثاء:
- أطفال: غير متاحة
- داخلية: فاعلة
- نسائية: فاعلة
- اسنان: فاعلة
- سوء تغذية: فاعلة

الأربعاء:
- أطفال: فاعلة
- داخلية: فاعلة
- نسائية: فاعلة
- اسنان: غير متاحة
- سوء تغذية: فاعلة

الخميس:
- أطفال: فاعلة
- داخلية: فاعلة
- نسائية: فاعلة
- اسنان: غير متاحة
- سوء تغذية: فاعلة

⏰ يبدأ الدوام الساعة الثامنة صباحاً وحتى الرابعة عصراً
    `
  },
  {
    id: 3,
    name: "دوام العيادات الخارجية - أطمه",
    schedule: `
🏥 مشفى بيدا للنسائية والأطفال في أطمه 
(دوام العيادات الخارجية)

السبت:
- الصيدلية: فاعلة
- مدخلي البيانات: فاعلة
- عيادة نسائية: فاعلة
- عيادة أطفال 1: عطّلة
- تمریض: فاعلة
- عيادة أطفال 2: غير متاحة
- تمریض: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة

الأحد:
- الصيدلية: فاعلة
- مدخلي البيانات: فاعلة
- عيادة نسائية: فاعلة
- عيادة أطفال 1: عطّلة
- تمریض: فاعلة
- عيادة أطفال 2: فاعلة
- تمریض: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة

الاثنين:
- الصيدلية: فاعلة
- مدخلي البيانات: فاعلة
- عيادة نسائية: فاعلة
- عيادة أطفال 1: عطّلة
- تمریض: فاعلة
- عيادة أطفال 2: فاعلة
- تمریض: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة

الثلاثاء:
- الصيدلية: عطّلة
- مدخلي البيانات: فاعلة
- عيادة نسائية: فاعلة
- عيادة أطفال 1: عطّلة
- تمریض: فاعلة
- عيادة أطفال 2: غير متاحة
- تمریض: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة

الأربعاء:
- الصيدلية: عطّلة
- مدخلي البيانات: فاعلة
- عيادة نسائية: فاعلة
- عيادة أطفال 1: عطّلة
- تمریض: فاعلة
- عيادة أطفال 2: غير متاحة
- تمریض: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة

الخميس:
- الصيدلية: عطّلة
- مدخلي البيانات: فاعلة
- عيادة نسائية: فاعلة
- عيادة أطفال 1: عطّلة
- تمریض: فاعلة
- عيادة أطفال 2: غير متاحة
- تمریض: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة
- عيادة أطفال 1: فاعلة
- تمریض: فاعلة
    `
  },
  {
    id: 4,
    name: "برنامج دوام العيادات الخارجية - أرمناز",
    schedule: `
🏥 مشفى أرمناز - برنامج دوام العيادات الخارجية 2025

العيادة                  السبت          الأحد          الإثنين        الثلاثاء       الأربعاء      الخميس
الداخلية                 فاعلة         فاعلة         فاعلة         فاعلة         فاعلة         فاعلة
القلبية                  فاعلة         فاعلة         فاعلة         فاعلة         فاعلة         فاعلة
الهضمية                 غير متاحة     غير متاحة     غير متاحة     غير متاحة     غير متاحة     غير متاحة
العصبية                 غير متاحة     غير متاحة     غير متاحة     غير متاحة     غير متاحة     غير متاحة
الجراحة العامة           فاعلة         غير متاحة     غير متاحة     غير متاحة     غير متاحة     غير متاحة
العظمية                  فاعلة         غير متاحة     غير متاحة     غير متاحة     غير متاحة     غير متاحة
الاذنية                  فاعلة         فاعلة         غير متاحة     غير متاحة     غير متاحة     غير متاحة
الأشعة                   فاعلة         فاعلة         غير متاحة     غير متاحة     غير متاحة     غير متاحة
البولية                  فاعلة         فاعلة         فاعلة         غير متاحة     غير متاحة     غير متاحة
    `
  },
  {
    id: 5,
    name: "برنامج دوام العيادات لعام 2025 - مركز كفر عروق",
    schedule: `
🏥 مركز كفر عروق - برنامج دوام العيادات لعام 2025

العيادات                السبت         الأحد         الإثنين       الثلاثاء       الأربعاء      الخميس
الداخلية                 عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة
الأطفال                 فاعلة         فاعلة         فاعلة         فاعلة         فاعلة         فاعلة
النسائية                 عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة
السنّية                 عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة
الأسنان                  عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة
الصيدلية                 عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة
المخابر                  عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة
اللقاح                   عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة
المساكن                  عطّلة         عطّلة         عطّلة         عطّلة         عطّلة         عطّلة

⏰ يبدأ الدوام الساعة 8:00 صباحاً وينتهي الساعة 4:00 مساءً
    `
  },
  {
    id: 6,
    name: "خدمات مركز أبين الصحي 2025",
    schedule: `
🏥 خدمات مركز أبين الصحي - آب 2025

📅 الجدول الأسبوعي:

الجمعة:
- العيادات: عطّلة
- داخلية: عطّلة
- أطفال: عطّلة
- نسائية: عطّلة
- تغذية / صحة مجتمعية: عطّلة
- إسعافات أولية: مناوبات
- المخابر: عطّلة
- اللقاح ثابت: عطّلة
- لقاح الجوال: عطّلة
- الصيدلية: عطّلة

السبت:
- العيادات: عطّلة
- داخلية: عطّلة
- أطفال: عطّلة
- نسائية: عطّلة
- تغذية / صحة مجتمعية: عطّلة
- إسعافات أولية: مناوبات
- المخابر: عطّلة
- اللقاح ثابت: عطّلة
- لقاح الجوال: عطّلة
- الصيدلية: عطّلة

الأحد إلى الخميس:
- العيادات: فاعلة
- داخلية: فاعلة
- أطفال: فاعلة
- نسائية: فاعلة
- تغذية / صحة مجتمعية: إداري
- إسعافات أولية: مناوبات
- المخابر: إداري
- اللقاح ثابت: إداري
- لقاح الجوال: إداري
- الصيدلية: إداري

⏰ يبدأ الدوام الإداري من الساعة 8 صباحاً حتى الساعة 4 مساءً.
    `
  }
]

export async function POST(request: Request) {
  try {
    const { message } = await request.json()
    
    // Simple keyword matching for demo purposes
    const lowerMessage = message.toLowerCase()
    
    // Check if user question matches any FAQ
    const matchedFaq = faqs.find(faq => 
      faq.question.toLowerCase().includes(lowerMessage) || 
      lowerMessage.includes(faq.question.toLowerCase().split(' ')[0])
    )
    
    if (matchedFaq) {
      return NextResponse.json({ 
        success: true, 
        response: matchedFaq.answer,
        type: 'faq'
      })
    }
    
    // Check if user is asking about clinic schedules
    const scheduleMatch = clinicSchedules.find(clinic => 
      lowerMessage.includes(clinic.id.toString()) || 
      lowerMessage.includes(clinic.name.toLowerCase().replace(/[0-9]/g, '').trim())
    )
    
    if (scheduleMatch) {
      return NextResponse.json({ 
        success: true, 
        response: scheduleMatch.schedule,
        type: 'schedule'
      })
    }
    
    // Default responses based on keywords
    let response = ""
    if (lowerMessage.includes("مرحبا") || lowerMessage.includes("أهلا")) {
      response = "مرحباً بك! كيف يمكنني مساعدتك في حجز موعد طبي؟"
    } else if (lowerMessage.includes("شكر") || lowerMessage.includes("معروف")) {
      response = "على الرحب والسعة! إذا كنت بحاجة لأي مساعدة إضافية، فلا تتردد في السؤال."
    } else if (lowerMessage.includes("وقت") || lowerMessage.includes("ساعات")) {
      response = "أوقات العمل تختلف حسب كل مركز طبي وعيادة. يمكنك الاطلاع على أوقات العمل عند اختيارك للمركز الطبي المطلوب."
    } else if (lowerMessage.includes("مركز") || lowerMessage.includes("عيادة")) {
      response = "يمكنك الاطلاع على جميع المراكز الطبية المتاحة من خلال صفحة 'المراكز الطبية' واختيار المركز المناسب لك."
    } else if (lowerMessage.includes("موعد") || lowerMessage.includes("حجز")) {
      response = "للحجز، يرجى الذهاب إلى صفحة 'المراكز الطبية' واختيار المركز الطبي المناسب لك، ثم اختيار العيادة والطبيب وتحديد التاريخ والوقت المناسبين لك."
    } else {
      // Random response from bot responses
      const botResponses = [
        "يمكنك حجز موعد طبي من خلال الذهاب إلى صفحة 'المراكز الطبية' واختيار المركز المناسب لك.",
        "هل تحتاج مساعدة في اختيار مركز طبي أو عيادة معينة؟",
        "يمكنني مساعدتك في الإجابة عن الأسئلة الشائعة حول نظام الحجز الطبي.",
        "هل تواجه أي مشكلة في استخدام نظام الحجز؟",
        "يمكنك الاطلاع على مواعيدك المحجوزة من خلال صفحة 'المواعيد'.",
        "هل تود معرفة المزيد عن خدمات مركز طبي معين؟"
      ]
      response = botResponses[Math.floor(Math.random() * botResponses.length)]
    }
    
    return NextResponse.json({ 
      success: true, 
      response: response,
      type: 'general'
    })
  } catch (error) {
    return NextResponse.json({ 
      success: false, 
      error: "حدث خطأ أثناء معالجة طلبك" 
    }, { status: 500 })
  }
}

export async function GET() {
  return NextResponse.json({ 
    success: true, 
    faqs: faqs,
    clinicSchedules: clinicSchedules.map(clinic => ({
      id: clinic.id,
      name: clinic.name
    })),
    message: "Chatbot API is working correctly"
  })
}